<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İp Mücadelesi - İki Kişilik</title>
    <style>
        /* CSS stilleri aynı kalır */
      #gameCanvas {
        border: 5px solid #3b82f6;
        background-color: #0d0d0d;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        /* YENİ: Mobil görünümü düzeltmek için esnekliği ve maksimum boyutu ekle */
        max-width: 95vw; /* Ekran genişliğinin %95'i kadar maksimum genişlik */
        max-height: 90vh; /* Ekran yüksekliğinin %90'ı kadar maksimum yükseklik */
        width: auto; /* Genişliği otomatik ayarla */
        height: auto; /* Yüksekliği otomatik ayarla */
    }
    
    body {
        /* ... (diğer body stilleri) ... */
        /* Ekranın kaymasını tamamen engellemek için */
        overflow: hidden; 
    }
        .controls-info {
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
        }
        .controls-info div {
            margin: 5px 0;
        }
        .player-1 { color: blue; font-weight: bold; }
        .player-2 { color: red; font-weight: bold; }
        /* YENİ: MOBİL KONTROL STİLLERİ */
       #mobileControls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px; /* 150px'den 120px'e düşürüldü */
            pointer-events: none;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
        }

        .joystick-container {
            position: relative;
            width: 120px; /* Joystick alanının genişliği 150px'den 120px'e düşürüldü */
            height: 120px; /* Joystick alanının yüksekliği 150px'den 120px'e düşürüldü */
            border-radius: 50%;
            pointer-events: auto;
            opacity: 0.8;
            /* YENİ: Ekranın alt kenarından biraz yukarı taşıma */
            margin-bottom: 5px; 
        }

        .joystick-stick {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: background-color 0.1s;
        }

        /* Oyuncu Renklerini Kullanarak Görünümü İyileştirme */
        #joystick-left .joystick-stick { background-color: rgba(59, 130, 246, 0.5); border-color: #3b82f6; } /* Mavi */
        #joystick-right .joystick-stick { background-color: rgba(255, 0, 0, 0.5); border-color: #ff0000; } /* Kırmızı */
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="700" height="400"></canvas>

    <div class="controls-info">
        <div class="player-1">Oyuncu 1 (Mavi Top): WASD</div>
        <div class="player-2">Oyuncu 2 (Kırmızı Top): OK Tuşları</div>
    </div>
    <div id="mobileControls">
        <div id="joystick-left" class="joystick-container">
            <div id="left-stick" class="joystick-stick"></div>
        </div>
        <div id="joystick-right" class="joystick-container">
            <div id="right-stick" class="joystick-stick"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- OYUN AYARLARI ---
        const settings = {
            width: canvas.width,
            height: canvas.height,
            ballRadius: 10,
            moveSpeed: 3, 
            ropeMaxDistance: 120, 
            maxLevel: 10,
            gameLoopInterval: 1000 / 60, // 60 FPS
            
            // YENİ: Lazerlerin başlayacağı ve ayrım çizgisinin çizileceği dikey X koordinatı
            laserStartBoundary: 150 
        };

        // --- SEVİYE VERİLERİ (Lazer x koordinatları 150'den büyük olmalıdır) ---
        const LSB = settings.laserStartBoundary; // Kısaltma

        const levels = [
            // BÖLÜM 1: Toplar LSB'nin solunda başlar
            { 
              start: { x: 50, y: 350 },
              start2: { x: 100, y: 350 }, 
              target: { x: 650, y: 50 },
              lasers: [
                { x: LSB + 50, y: 100, w: 20, h: 150, speed: 1.5, dir: 1 }, // LSB+50 = 200
                { x: LSB + 200, y: 50, w: 20, h: 150, speed: 2, dir: -1 }, // LSB+200 = 350
                { x: LSB + 350, y: 150, w: 20, h: 150, speed: 1.8, dir: 1 } // LSB+350 = 500
              ]},
            
            // Bölüm 2
            { start: { x: 50, y: 300 }, start2: { x: 50, y: 350 }, target: { x: 650, y: 50 },
              lasers: [
                { x: LSB + 50, y: 0, w: 20, h: 250, speed: 2.5, dir: 1 },
                { x: LSB + 300, y: 150, w: 20, h: 250, speed: 1.5, dir: -1 }
              ]},
            
            // Bölüm 3
            { start: { x: 50, y: 300 }, start2: { x: 80, y: 300 }, target: { x: 650, y: 200 },
              lasers: [
                { x: LSB + 100, y: 0, w: 15, h: 200, speed: 3, dir: 1 },
                { x: LSB + 250, y: 200, w: 15, h: 200, speed: 3, dir: -1 }
              ]},
            
            // Bölüm 4
            { start: { x: 50, y: 350 }, start2: { x: 50, y: 300 }, target: { x: 650, y: 50 },
              lasers: [
                { x: LSB + 30, y: 0, w: 20, h: 150, speed: 1, dir: 1 },
                { x: LSB + 150, y: 250, w: 20, h: 150, speed: 1.5, dir: -1 },
                { x: LSB + 300, y: 0, w: 20, h: 150, speed: 2, dir: 1 }
              ]},
            
            // Diğer seviyeler de LSB'ye göre ayarlanabilir, şimdilik ilk 4'ü düzenledim.
            // ... (Kalan seviyeler) ...
            { start: { x: 50, y: 350 }, start2: { x: 120, y: 350 }, target: { x: 650, y: 350 },
              lasers: [
                { x: LSB + 50, y: 100, w: 20, h: 200, speed: 1.2, dir: 1 },
                { x: LSB + 250, y: 0, w: 20, h: 200, speed: 1.7, dir: -1 },
                { x: LSB + 450, y: 100, w: 20, h: 200, speed: 1.5, dir: 1 }
              ]},
            { start: { x: 50, y: 300 }, start2: { x: 100, y: 300 }, target: { x: 650, y: 200 },
              lasers: [
                { x: LSB + 50, y: 0, w: 15, h: 150, speed: 2.2, dir: 1 },
                { x: LSB + 350, y: 250, w: 15, h: 150, speed: 2.2, dir: -1 }
              ]},
            { start: { x: 50, y: 350 }, start2: { x: 150, y: 350 }, target: { x: 650, y: 50 },
              lasers: [
                { x: LSB + 30, y: 50, w: 10, h: 300, speed: 1, dir: 1 },
                { x: LSB + 130, y: 0, w: 10, h: 350, speed: 1.5, dir: -1 },
                { x: LSB + 250, y: 50, w: 10, h: 300, speed: 1.2, dir: 1 },
                { x: LSB + 370, y: 0, w: 10, h: 350, speed: 1.6, dir: -1 }
              ]},
            { start: { x: 50, y: 350 }, start2: { x: 50, y: 300 }, target: { x: 650, y: 350 },
              lasers: [
                { x: LSB + 50, y: 0, w: 25, h: 200, speed: 1.8, dir: 1 },
                { x: LSB + 200, y: 200, w: 25, h: 200, speed: 1.8, dir: -1 },
                { x: LSB + 350, y: 0, w: 25, h: 200, speed: 1.8, dir: 1 }
              ]},
            { start: { x: 50, y: 300 }, start2: { x: 170, y: 300 }, target: { x: 650, y: 200 }, 
              lasers: [
                { x: LSB + 100, y: 0, w: 20, h: 400, speed: 0.5, dir: 1 },
                { x: LSB + 300, y: 0, w: 20, h: 400, speed: 0.5, dir: -1 }
              ]},
            { start: { x: 50, y: 300 }, start2: { x: 100, y: 300 }, target: { x: 650, y: 200 },
              lasers: [
                { x: LSB + 50, y: 0, w: 10, h: 100, speed: 3, dir: 1 },
                { x: LSB + 150, y: 300, w: 10, h: 100, speed: 3, dir: -1 },
                { x: LSB + 250, y: 0, w: 10, h: 100, speed: 3, dir: 1 },
                { x: LSB + 350, y: 300, w: 10, h: 100, speed: 3, dir: -1 },
                { x: LSB + 450, y: 0, w: 10, h: 100, speed: 3, dir: 1 }
              ]}
        ];

        // --- OYUN DURUMU ---
        let gameState = {
            currentLevel: 1,
            balls: [],
            lasers: [],
            target: {},
            gameOver: false,
            levelComplete: false
        };

        let keys = {}; 
        let gameLoopTimer = null; 

        // --- FONKSİYONLAR ---

        function initLevel() {
            if (gameLoopTimer) {
                clearTimeout(gameLoopTimer);
            }

            const levelData = levels[gameState.currentLevel - 1];
            
            gameState.balls = [
                { x: levelData.start.x, y: levelData.start.y, color: 'blue', dx: 0, dy: 0 },
                { x: levelData.start2.x, y: levelData.start2.y, color: 'red', dx: 0, dy: 0 }
            ];
            // Lazer X koordinatları artık seviye verilerinde zaten LSB'ye göre ayarlandı.
            gameState.lasers = JSON.parse(JSON.stringify(levelData.lasers));
            gameState.target = levelData.target;
            gameState.gameOver = false;
            gameState.levelComplete = false;
            keys = {}; 

            draw();
            gameLoop();
        }

        /**
         * Tüm oyun objelerini çizer.
         * YENİ: Ayırıcı Dikey Çizgi Eklendi.
         */
        function draw() {
            ctx.fillStyle = '#0d0d0d';
            ctx.fillRect(0, 0, settings.width, settings.height);

            if (gameState.balls.length === 0) return;

            // --- YENİ: Ayırıcı Dikey Çizgiyi Çiz ---
            ctx.strokeStyle = '#3b82f6'; // Mavi çerçeve ile aynı renk, noktalı
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]); // Noktalı çizgi
            ctx.beginPath();
            ctx.moveTo(settings.laserStartBoundary, 0);
            ctx.lineTo(settings.laserStartBoundary, settings.height);
            ctx.stroke();
            ctx.setLineDash([]); // Çizgiyi sıfırla

            const ball1 = gameState.balls[0];
            const ball2 = gameState.balls[1];
            const radius = settings.ballRadius;
            
            // --- İpi Çiz ---
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(ball1.x, ball1.y);
            ctx.lineTo(ball2.x, ball2.y);
            ctx.stroke();

            // --- Topları Çiz ---
            [ball1, ball2].forEach(ball => {
                ctx.fillStyle = ball.color;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, radius, 0, Math.PI * 2);
                ctx.fill();
            });

            // --- Lazerleri Çiz ---
            gameState.lasers.forEach(laser => {
                ctx.fillStyle = '#ff0000'; 
                ctx.fillRect(laser.x, laser.y, laser.w, laser.h);
            });

            // --- Hedefi Çiz ---
            const target = gameState.target;
            ctx.fillStyle = '#ffcc00';
            ctx.beginPath();
            ctx.arc(target.x, target.y, radius * 1.5, 0, Math.PI * 2);
            ctx.fill();

            // --- Skor/Durum Bilgisi ve Mesajlar (Önceki kodla aynı) ---
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Bölüm: ${gameState.currentLevel} / ${settings.maxLevel}`, settings.width / 2, 30);

            if (gameState.gameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, settings.width, settings.height);
                ctx.fillStyle = '#ff0000';
                ctx.font = '40px Arial';
                const msg = gameState.currentLevel === settings.maxLevel ? "Tebrikler! Oyunu Bitirdin!" : "OYUN BİTTİ!";
                ctx.fillText(msg, settings.width / 2, settings.height / 2);
                ctx.font = '20px Arial';
                ctx.fillText('Yeniden Başlamak için YENİLE (F5)', settings.width / 2, settings.height / 2 + 50);
            } else if (gameState.levelComplete) {
                 ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, settings.width, settings.height);
                ctx.fillStyle = '#00ff00';
                ctx.font = '40px Arial';
                const msg = gameState.currentLevel === settings.maxLevel ? "Tebrikler!" : `BÖLÜM ${gameState.currentLevel} TAMAMLANDI!`;
                ctx.fillText(msg, settings.width / 2, settings.height / 2);
                if (gameState.currentLevel < settings.maxLevel) {
                    ctx.font = '20px Arial';
                    ctx.fillText('Yeni Bölüm Yükleniyor...', settings.width / 2, settings.height / 2 + 50);
                }
            }
        }

        // --- Geri kalan tüm fonksiyonlar (updateBallSpeeds, updateBalls, updateLasers, checkCollisionsAndWin, nextLevel, gameLoop, GİRDİ YÖNETİMİ) önceki kodla aynı kalır. ---

        function updateBallSpeeds() {
            const ball1 = gameState.balls[0];
            const ball2 = gameState.balls[1];
            
            ball1.dx = 0; ball1.dy = 0;
            ball2.dx = 0; ball2.dy = 0;

            if (keys['w']) ball1.dy = -settings.moveSpeed;
            if (keys['s']) ball1.dy = settings.moveSpeed;
            if (keys['a']) ball1.dx = -settings.moveSpeed;
            if (keys['d']) ball1.dx = settings.moveSpeed;

            if (keys['arrowup']) ball2.dy = -settings.moveSpeed;
            if (keys['arrowdown']) ball2.dy = settings.moveSpeed;
            if (keys['arrowleft']) ball2.dx = -settings.moveSpeed;
            if (keys['arrowright']) ball2.dx = settings.moveSpeed;
        }

        function updateBalls() {
            const ball1 = gameState.balls[0];
            const ball2 = gameState.balls[1];
            const R = settings.ballRadius;
            const W = settings.width;
            const H = settings.height;

            // 1. Pozisyonları hıza göre güncelle
            ball1.x += ball1.dx;
            ball1.y += ball1.dy;
            ball2.x += ball2.dx;
            ball2.y += ball2.dy;

            // 2. İp Kısıtlaması (Constraint)
            let dx = ball2.x - ball1.x;
            let dy = ball2.y - ball1.y;
            let dist = Math.sqrt(dx * dx + dy * dy);

            if (dist > settings.ropeMaxDistance) {
                let angle = Math.atan2(dy, dx);
                let correction = (dist - settings.ropeMaxDistance) / 2;
                
                ball1.x += Math.cos(angle) * correction;
                ball1.y += Math.sin(angle) * correction;
                ball2.x -= Math.cos(angle) * correction;
                ball2.y -= Math.sin(angle) * correction;
            }

            // 3. Duvar Çarpışması (Sınırlar)
            const limitBall = (ball) => {
                if (ball.x < R) ball.x = R;
                if (ball.x > W - R) ball.x = W - R;
                if (ball.y < R) ball.y = R;
                if (ball.y > H - R) ball.y = H - R;
            };
            
            limitBall(ball1);
            limitBall(ball2);
        }

        function updateLasers() {
            const H = settings.height;
            gameState.lasers.forEach(laser => {
                laser.y += laser.speed * laser.dir;

                if (laser.y <= 0) {
                    laser.y = 0;
                    laser.dir *= -1;
                } else if ((laser.y + laser.h) >= H) {
                    laser.y = H - laser.h;
                    laser.dir *= -1;
                }
            });
        }

        function checkCollisionsAndWin() {
            const ball1 = gameState.balls[0];
            const ball2 = gameState.balls[1];
            const R = settings.ballRadius;

            // Lazer Çarpışması
            const checkLaserCollision = (ball) => {
                return gameState.lasers.some(laser => {
                    const closestX = Math.max(laser.x, Math.min(ball.x, laser.x + laser.w));
                    const closestY = Math.max(laser.y, Math.min(ball.y, laser.y + laser.h));
                    const distX = ball.x - closestX;
                    const distY = ball.y - closestY;
                    return (distX * distX + distY * distY) < (R * R);
                });
            };

            if (checkLaserCollision(ball1) || checkLaserCollision(ball2)) {
                gameState.gameOver = true;
                return;
            }
            
            // Hedef Kontrolü
            const target = gameState.target;
            const targetRadius = R * 1.5;

            const isAtTarget = (ball) => {
                const dist = Math.sqrt(Math.pow(ball.x - target.x, 2) + Math.pow(ball.y - target.y, 2));
                return dist <= targetRadius;
            };

            if (isAtTarget(ball1) && isAtTarget(ball2)) {
                gameState.levelComplete = true;
                if (gameState.currentLevel < settings.maxLevel) {
                    setTimeout(nextLevel, 2000);
                } else {
                    gameState.gameOver = true; 
                }
            }
        }

        function nextLevel() {
            gameState.currentLevel++;
            if (gameState.currentLevel <= settings.maxLevel) {
                initLevel(); 
            }
        }

        function gameLoop() {
            if (!gameState.gameOver && !gameState.levelComplete) {
                updateBallSpeeds();
                updateBalls();
                updateLasers();
                checkCollisionsAndWin();
            }
            draw();
            
            gameLoopTimer = setTimeout(gameLoop, settings.gameLoopInterval);
        }

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (['w', 'a', 's', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(key)) {
                e.preventDefault();
            }
            keys[key] = true;
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = false;
        });

        // --- BAŞLANGIÇ ---
        initLevel();
        // --- MOBİL JOYSTICK YÖNETİMİ ---

        const leftJoystick = document.getElementById('joystick-left');
        const rightJoystick = document.getElementById('joystick-right');
        const leftStick = document.getElementById('left-stick');
        const rightStick = document.getElementById('right-stick');
        
        // Sanal klavye tuşlarını tutmak için kullanılan harita
        const virtualKeys = {
            'player1': { 'up': 'w', 'down': 's', 'left': 'a', 'right': 'd' },
            'player2': { 'up': 'arrowup', 'down': 'arrowdown', 'left': 'arrowleft', 'right': 'arrowright' }
        };

        // Mevcut klavye girdilerini temizler (mobil joystick için)
        function clearVirtualKeys(player) {
            Object.values(virtualKeys[player]).forEach(key => {
                keys[key] = false;
            });
        }

        // Joystick pozisyonunu günceller ve hareket yönünü ayarlar
        function updateJoystick(joystickContainer, joystickStick, clientX, clientY, player) {
            const rect = joystickContainer.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const maxRadius = rect.width / 2;

            let dx = clientX - centerX;
            let dy = clientY - centerY;
            let distance = Math.sqrt(dx * dx + dy * dy);

            // Çubuğun hareketini joystick alanıyla sınırla
            if (distance > maxRadius) {
                dx = dx / distance * maxRadius;
                dy = dy / distance * maxRadius;
                distance = maxRadius;
            }

            // Çubuğu yeni pozisyona taşı
            joystickStick.style.transform = `translate(${dx - 35}px, ${dy - 35}px)`; // -35px: Çubuğun kendi genişliğinin/2'si

            // Sanal tuşları güncelle
            clearVirtualKeys(player);

            // Yönler için basit eşik kontrolü
            const threshold = 15;

            if (dy < -threshold) {
                keys[virtualKeys[player].up] = true;
            } else if (dy > threshold) {
                keys[virtualKeys[player].down] = true;
            }

            if (dx < -threshold) {
                keys[virtualKeys[player].left] = true;
            } else if (dx > threshold) {
                keys[virtualKeys[player].right] = true;
            }
        }

        // Joystick'i merkeze sıfırla ve sanal tuşları bırak
        function resetJoystick(joystickStick, player) {
            joystickStick.style.transform = 'translate(-50%, -50%)';
            clearVirtualKeys(player);
        }

        // --- Dokunma Olayı Dinleyicileri ---

        // Oyuncu 1 (Sol Joystick)
        leftJoystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            // Birden fazla parmak olabilir, ilk parmağı al
            const touch = e.touches[0];
            leftJoystick.touchId = touch.identifier; 
            updateJoystick(leftJoystick, leftStick, touch.clientX, touch.clientY, 'player1');
        });

        leftJoystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                if (touch.identifier === leftJoystick.touchId) {
                    updateJoystick(leftJoystick, leftStick, touch.clientX, touch.clientY, 'player1');
                    break;
                }
            }
        });

        leftJoystick.addEventListener('touchend', (e) => {
            // Sadece bu joystick'i hareket ettiren parmak kalktıysa sıfırla
            if (!Array.from(e.changedTouches).some(t => t.identifier === leftJoystick.touchId)) return;
            resetJoystick(leftStick, 'player1');
            leftJoystick.touchId = null;
        });

        leftJoystick.addEventListener('touchcancel', (e) => {
            // Parmağın kaybolması durumunda (örneğin bildirim geldiğinde)
            if (!Array.from(e.changedTouches).some(t => t.identifier === leftJoystick.touchId)) return;
            resetJoystick(leftStick, 'player1');
            leftJoystick.touchId = null;
        });
        
        // Oyuncu 2 (Sağ Joystick) - Mantık aynı
        rightJoystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            rightJoystick.touchId = touch.identifier;
            updateJoystick(rightJoystick, rightStick, touch.clientX, touch.clientY, 'player2');
        });

        rightJoystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                if (touch.identifier === rightJoystick.touchId) {
                    updateJoystick(rightJoystick, rightStick, touch.clientX, touch.clientY, 'player2');
                    break;
                }
            }
        });

        rightJoystick.addEventListener('touchend', (e) => {
            if (!Array.from(e.changedTouches).some(t => t.identifier === rightJoystick.touchId)) return;
            resetJoystick(rightStick, 'player2');
            rightJoystick.touchId = null;
        });

        rightJoystick.addEventListener('touchcancel', (e) => {
            if (!Array.from(e.changedTouches).some(t => t.identifier === rightJoystick.touchId)) return;
            resetJoystick(rightStick, 'player2');
            rightJoystick.touchId = null;
        });

        // NOT: İki parmakla aynı anda oynamayı desteklemek için her bir
        // joystick'in, kendi dokunuş kimliğini (touchId) takip etmesi gerekir. 
        // Yukarıdaki kod bu mantığı uygulamaktadır.

        // --- BAŞLANGIÇ ---
        initLevel();
    </script>
</body>
</html>